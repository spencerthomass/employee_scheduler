<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emissions Plus Scheduler</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://bernardo-castilho.github.io/DragDropTouch/DragDropTouch.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        tr.emp-row { height: 38px; }
        td { border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        
        .modal-mask { position: fixed; z-index: 50; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; }
        
        .col-name { width: 200px; min-width: 200px; }
        .col-day { width: 120px; min-width: 120px; }
        .col-total { width: 80px; min-width: 80px; }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden text-sm">
    <div id="app" class="flex flex-col md:flex-row h-full font-sans">
        
        <div v-if="isAdmin" class="w-full h-80 md:w-56 md:h-auto bg-white shadow-xl flex flex-col z-20 border-b md:border-b-0 md:border-r border-gray-300 transition-all shrink-0">
            <div class="p-4 bg-gray-800 text-white font-bold flex justify-between items-center shrink-0">
                <div>
                    Admin Tools
                    <div class="text-xs font-normal text-gray-400 mt-1">Drag shops to grid</div>
                </div>
                <div class="md:hidden text-xs text-gray-400">(Scroll for Sched)</div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-3 bg-gray-50">
                <div v-for="loc in locations" :key="loc.id" 
                     draggable="true" @dragstart="onDragStart($event, loc.id)"
                     class="bg-white p-3 mb-3 rounded shadow-sm border-l-4 border-indigo-500 cursor-move hover:bg-indigo-50 transition-all select-none touch-manipulation">
                    <div class="font-bold text-gray-700">{{ loc.name }}</div>
                </div>
            </div>
            
            <div class="p-3 bg-gray-100 border-t grid grid-cols-2 md:grid-cols-1 gap-2 shrink-0">
                <button @click="showModal('staff')" class="w-full py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 shadow text-center">Manage Staff</button>
                <button @click="showModal('shops')" class="w-full py-2 bg-indigo-600 text-white rounded font-bold hover:bg-indigo-700 shadow text-center">Manage Shops</button>
            </div>
        </div>

        <div class="flex-1 flex flex-col min-w-0 h-full overflow-hidden">
            
            <div class="bg-white border-b p-3 flex justify-between items-center shadow-sm z-10 shrink-0 gap-2 overflow-x-auto">
                <div class="flex items-center space-x-2 md:space-x-6">
                    <div class="flex items-center shrink-0">
                        <img src="https://emissions-plus.com/wp-content/uploads/2018/10/cropped-eplus-logo-1.png" alt="Emissions Plus" class="h-8 md:h-10 mr-2 md:mr-3">
                        <span class="text-gray-700 font-extrabold text-lg md:text-xl tracking-tight hidden md:block">Scheduler</span>
                    </div>

                    <div class="flex items-center bg-gray-100 rounded-lg p-1 border shrink-0">
                        <button @click="changeWeek(-7)" class="w-8 h-8 flex items-center justify-center hover:bg-white rounded text-gray-600 font-bold">&lt;</button>
                        <span class="px-2 md:px-4 font-bold text-gray-700 text-xs md:text-sm whitespace-nowrap">{{ formatDateReadable(weekDates[0]) }}</span>
                        <button @click="changeWeek(7)" class="w-8 h-8 flex items-center justify-center hover:bg-white rounded text-gray-600 font-bold">&gt;</button>
                    </div>
                </div>
                
                <div class="flex items-center space-x-2 md:space-x-4 shrink-0">
                    <label class="hidden md:flex items-center space-x-2 cursor-pointer select-none">
                        <input type="checkbox" v-model="showCoverage" class="form-checkbox h-4 w-4 text-indigo-600">
                        <span class="text-gray-600 font-bold text-xs">Shop Counts</span>
                    </label>
                    <div class="h-6 w-px bg-gray-300 hidden md:block"></div>
                    <button v-if="!isAdmin" @click="showModal('login')" class="text-indigo-600 hover:underline font-bold px-2 md:px-3 text-xs md:text-sm">Admin Login</button>
                    <button v-else @click="logout" class="text-red-600 hover:underline px-2 md:px-3 text-xs md:text-sm">Logout</button>
                </div>
            </div>

            <div class="flex-1 overflow-auto bg-gray-50 flex flex-col relative">
                
                <div v-if="showCoverage" class="bg-white border-b-4 border-gray-200 p-4 shadow-sm shrink-0 overflow-x-auto">
                    <h2 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Shop Coverage</h2>
                    <table class="w-full border-collapse text-xs">
                        <thead>
                            <tr>
                                <th class="col-name text-left p-1 text-gray-400">Location</th>
                                <th v-for="date in weekDates" :key="date" class="col-day text-center p-1 text-gray-400">{{ getDayName(date) }}</th>
                                <th class="col-total"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="loc in locations" :key="loc.id" class="border-b border-gray-100">
                                <td class="col-name p-2 font-bold text-gray-700">{{ loc.name }}</td>
                                <td v-for="date in weekDates" :key="date" class="col-day p-1 text-center">
                                    <div :class="getShopCount(loc.id, date) === 0 ? 'bg-red-100 text-red-600 border-red-200' : 'bg-green-100 text-green-700 border-green-200'" 
                                         class="inline-block px-3 py-1 rounded font-bold border">
                                        {{ getShopCount(loc.id, date) }}
                                    </div>
                                </td>
                                <td class="col-total"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="flex-1 min-h-0">
                    <table class="w-full border-collapse bg-white">
                        <thead class="sticky top-0 z-10 bg-gray-100 shadow-sm">
                            <tr>
                                <th class="col-name p-3 text-left text-gray-600 font-bold border-r bg-gray-100">Employee</th>
                                <th v-for="date in weekDates" :key="date" class="col-day p-2 text-center border-r bg-gray-100">
                                    <div class="font-bold text-gray-800">{{ getDayName(date) }}</div>
                                    <div class="text-xs text-gray-500">{{ formatDateShort(date) }}</div>
                                </th>
                                <th class="col-total p-2 text-center text-gray-600 font-bold bg-gray-100">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="emp in employees" :key="emp.id" class="emp-row bg-white hover:bg-gray-50 transition-colors">
                                <td class="col-name px-3 py-1 border-r font-bold text-gray-700 bg-white sticky left-0 shadow-sm border-b">
                                    <div class="flex items-center">
                                        <div class="w-7 h-7 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-xs mr-2 shrink-0">{{ getInitials(emp.name) }}</div>
                                        <span class="truncate">{{ emp.name }}</span>
                                    </div>
                                </td>
                                <td v-for="date in weekDates" :key="date"
                                    @dragover.prevent @drop="onDrop($event, emp.id, date)"
                                    class="col-day border-r border-b p-1 text-center relative group touch-manipulation">
                                    
                                    <div v-if="!grid[emp.id][date]" class="h-full flex items-center justify-center text-gray-200 text-xs select-none">-</div>

                                    <div v-if="grid[emp.id][date]" 
                                         :class="getWarning(emp.id, date) ? 'bg-yellow-100 text-yellow-800 border-yellow-300' : 'bg-indigo-100 text-indigo-800 border-indigo-100'"
                                         class="mx-1 py-1 rounded text-xs font-bold shadow-sm flex justify-between items-center px-2 group/cell cursor-default border transition-colors select-none"
                                         :title="getWarning(emp.id, date)">
                                        
                                        <div class="flex items-center truncate">
                                            <span v-if="getWarning(emp.id, date)" class="mr-1 text-lg">⚠️</span>
                                            <span class="truncate">{{ grid[emp.id][date].name }}</span>
                                        </div>
                                        <button v-if="isAdmin" @click="removeShift(emp.id, date)" class="hidden group-hover/cell:block text-indigo-400 hover:text-red-500 font-bold ml-1">&times;</button>
                                    </div>
                                </td>
                                <td class="col-total border-b text-center font-bold text-gray-500">{{ countDays(emp.id) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div v-if="modalMode" class="modal-mask" @click.self="modalMode = null">
                <div v-if="modalMode === 'login'" class="bg-white p-6 rounded shadow-lg w-80">
                    <h3 class="text-lg font-bold mb-4">Admin Access</h3>
                    <input type="password" v-model="passwordInput" placeholder="Password" class="w-full border p-2 rounded mb-4" @keyup.enter="login">
                    <button @click="login" class="w-full bg-indigo-600 text-white py-2 rounded font-bold">Login</button>
                </div>
                
                <div v-if="modalMode === 'staff'" class="bg-white p-6 rounded shadow-lg w-96 max-h-[80vh] flex flex-col">
                    <h3 class="text-lg font-bold mb-4">Manage Employees</h3>
                    <div class="flex mb-4">
                        <input v-model="newItemName" placeholder="New Employee Name" class="border p-2 rounded-l flex-1">
                        <button @click="createItem('employees')" class="bg-green-600 text-white px-4 rounded-r font-bold">+</button>
                    </div>
                    <div class="flex-1 overflow-y-auto border-t pt-2">
                        <div v-for="emp in employees" :key="emp.id" class="flex justify-between items-center py-2 border-b">
                            <span class="font-bold text-gray-700 truncate w-32">{{ emp.name }}</span>
                            <div class="flex items-center space-x-1">
                                <button @click="openConstraints(emp)" class="text-gray-500 hover:text-gray-800 text-xs font-bold border border-gray-200 px-2 py-1 rounded">Rules</button>
                                <button @click="updateItem('employees', emp.id, emp.name)" class="text-blue-500 hover:text-blue-700 text-xs font-bold border border-blue-200 px-2 py-1 rounded">Edit</button>
                                <button @click="deleteItem('employees', emp.id)" class="text-red-500 hover:text-red-700 text-xs font-bold border border-red-200 px-2 py-1 rounded">Del</button>
                            </div>
                        </div>
                    </div>
                    <button @click="modalMode = null" class="mt-4 text-gray-500 hover:underline">Close</button>
                </div>
                
                <div v-if="modalMode === 'shops'" class="bg-white p-6 rounded shadow-lg w-96 max-h-[80vh] flex flex-col">
                    <h3 class="text-lg font-bold mb-4">Manage Shops</h3>
                    <div class="flex mb-4">
                        <input v-model="newItemName" placeholder="New Shop Name" class="border p-2 rounded-l flex-1">
                        <button @click="createItem('locations')" class="bg-green-600 text-white px-4 rounded-r font-bold">+</button>
                    </div>
                    <div class="flex-1 overflow-y-auto border-t pt-2">
                        <div v-for="loc in locations" :key="loc.id" class="flex justify-between items-center py-2 border-b">
                            <span class="font-bold text-gray-700">{{ loc.name }}</span>
                            <div class="flex items-center space-x-1">
                                <button @click="updateItem('locations', loc.id, loc.name)" class="text-blue-500 hover:text-blue-700 text-xs font-bold border border-blue-200 px-2 py-1 rounded">Edit</button>
                                <button @click="deleteItem('locations', loc.id)" class="text-red-500 hover:text-red-700 text-xs font-bold border border-red-200 px-2 py-1 rounded">Del</button>
                            </div>
                        </div>
                    </div>
                    <button @click="modalMode = null" class="mt-4 text-gray-500 hover:underline">Close</button>
                </div>

                <div v-if="modalMode === 'constraints'" class="bg-white p-6 rounded shadow-lg w-[700px] max-h-[90vh] flex flex-col">
                    <h3 class="text-lg font-bold mb-2">Rules for <span class="text-indigo-600">{{ selectedEmp.name }}</span></h3>
                    <p class="text-xs text-gray-500 mb-4">Set Preferences and Restrictions.</p>
                    <div class="flex space-x-4 flex-1 overflow-hidden">
                        
                        <div class="flex-1 flex flex-col border rounded p-2 bg-green-50 border-green-200">
                            <h4 class="font-bold text-xs uppercase text-green-700 mb-2">Preferred Locations</h4>
                            <div class="overflow-y-auto flex-1 space-y-1">
                                <label v-for="loc in locations" :key="loc.id" class="flex items-center space-x-2 p-1 bg-white border rounded">
                                    <input type="checkbox" :checked="constraints[selectedEmp.id].preferred_locs.includes(loc.id)" @change="toggleConstraint('preference', loc.id, $event)">
                                    <span class="text-sm">{{ loc.name }}</span>
                                </label>
                            </div>
                        </div>

                        <div class="flex-1 flex flex-col border rounded p-2 bg-red-50 border-red-200">
                            <h4 class="font-bold text-xs uppercase text-red-700 mb-2">Avoid Locations</h4>
                            <div class="overflow-y-auto flex-1 space-y-1">
                                <label v-for="loc in locations" :key="loc.id" class="flex items-center space-x-2 p-1 bg-white border rounded">
                                    <input type="checkbox" :checked="constraints[selectedEmp.id].bad_locs.includes(loc.id)" @change="toggleConstraint('location', loc.id, $event)">
                                    <span class="text-sm">{{ loc.name }}</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="flex-1 flex flex-col border rounded p-2 bg-red-50 border-red-200">
                            <h4 class="font-bold text-xs uppercase text-red-700 mb-2">Avoid Coworkers</h4>
                            <div class="overflow-y-auto flex-1 space-y-1">
                                <label v-for="emp in employees" :key="emp.id" v-show="emp.id !== selectedEmp.id" class="flex items-center space-x-2 p-1 bg-white border rounded">
                                    <input type="checkbox" :checked="constraints[selectedEmp.id].bad_coworkers.includes(emp.id)" @change="toggleConstraint('employee', emp.id, $event)">
                                    <span class="text-sm">{{ emp.name }}</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <button @click="modalMode = 'staff'" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded font-bold">Back</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;
        createApp({
            setup() {
                const toIsoDate = (d) => {
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };

                const getMonday = (d) => {
                    d = new Date(d);
                    const day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1);
                    d.setDate(diff);
                    return d;
                }

                const currentMonday = ref(toIsoDate(getMonday(new Date())));
                const employees = ref([]); const locations = ref([]); const weekDates = ref([]);
                const grid = ref({}); const constraints = ref({});
                const isAdmin = ref(false); 
                const showCoverage = ref(false); 
                
                const modalMode = ref(null); const passwordInput = ref(""); const newItemName = ref("");
                const selectedEmp = ref(null);

                const fetchData = async () => {
                    const res = await fetch(`/api/roster/${currentMonday.value}`);
                    const data = await res.json();
                    employees.value = data.employees.sort((a,b) => a.name.localeCompare(b.name));
                    locations.value = data.locations.sort((a,b) => a.name.localeCompare(b.name));
                    weekDates.value = data.week_dates; grid.value = data.grid;
                    constraints.value = data.constraints; isAdmin.value = data.is_admin;
                };

                const getWarning = (empId, date) => {
                    const loc = grid.value[empId][date];
                    if (!loc) return null;
                    const rule = constraints.value[empId];
                    if (!rule) return null;

                    // 1. HARD Constraint (Forbidden Location)
                    if (rule.bad_locs.includes(loc.id)) return `${employees.value.find(e=>e.id==empId).name} avoids ${loc.name}`;

                    // 2. SOFT Constraint (Preferred Location)
                    // If employee has ANY preferences, but current loc is NOT one of them -> Warning
                    if (rule.preferred_locs.length > 0 && !rule.preferred_locs.includes(loc.id)) {
                        return "Not a preferred location";
                    }

                    // 3. HARD Constraint (Forbidden Coworker)
                    const coworkers = [];
                    for(const otherId in grid.value) {
                        if (parseInt(otherId) !== empId && grid.value[otherId][date] && grid.value[otherId][date].id === loc.id) {
                            coworkers.push(parseInt(otherId));
                        }
                    }
                    const badApple = coworkers.find(c => rule.bad_coworkers.includes(c));
                    if (badApple) return `Conflict with ${employees.value.find(e=>e.id==badApple).name}`;
                    
                    return null;
                };

                const openConstraints = (emp) => { selectedEmp.value = emp; modalMode.value = 'constraints'; };
                
                const toggleConstraint = async (type, targetId, evt) => {
                    const empId = selectedEmp.value.id;
                    const isAdd = evt.target.checked;
                    const method = isAdd ? 'POST' : 'DELETE';
                    
                    // Route Logic
                    let apiPath = type;
                    let list = [];
                    if (type === 'preference') {
                        apiPath = 'preferences/location';
                        list = constraints.value[empId].preferred_locs;
                    } else if (type === 'location') {
                        apiPath = 'constraints/location';
                        list = constraints.value[empId].bad_locs;
                    } else {
                        apiPath = 'constraints/employee';
                        list = constraints.value[empId].bad_coworkers;
                    }

                    if(isAdd) list.push(targetId); else { const idx = list.indexOf(targetId); if(idx>-1) list.splice(idx,1); }
                    
                    await fetch(`/api/${apiPath}`, { 
                        method: method, 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify({ employee_id: empId, target_id: targetId }) 
                    });
                    
                    if(type === 'employee') fetchData(); // Refresh for bidirectional update
                };

                const login = async () => { const res = await fetch('/api/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ password: passwordInput.value }) }); if (res.ok) { modalMode.value = null; passwordInput.value = ""; fetchData(); } else alert("Incorrect Password"); };
                const logout = async () => { await fetch('/api/logout', { method: 'POST' }); fetchData(); };
                
                const changeWeek = (days) => { 
                    const d = new Date(currentMonday.value + 'T00:00:00');
                    d.setDate(d.getDate() + days);
                    currentMonday.value = toIsoDate(d);
                    fetchData(); 
                };
                
                const createItem = async (type) => { if(!newItemName.value) return; await fetch(`/api/${type}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: newItemName.value }) }); newItemName.value = ""; fetchData(); };
                const updateItem = async (type, id, oldName) => { const newName = prompt("Rename:", oldName); if (!newName || newName === oldName) return; await fetch(`/api/${type}/${id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: newName }) }); fetchData(); };
                const deleteItem = async (type, id) => { if(!confirm("Are you sure?")) return; await fetch(`/api/${type}/${id}`, { method: 'DELETE' }); fetchData(); };
                
                const onDragStart = (evt, locId) => { evt.dataTransfer.effectAllowed = 'copy'; evt.dataTransfer.setData('locId', locId); };
                const onDrop = async (evt, empId, dateStr) => { if(!isAdmin.value) return; const locId = evt.dataTransfer.getData('locId'); if (!locId) return; const loc = locations.value.find(l => l.id == locId); grid.value[empId][dateStr] = loc; await fetch('/api/assign', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ employee_id: empId, date_str: dateStr, location_id: parseInt(locId) }) }); };
                const removeShift = async (empId, dateStr) => { grid.value[empId][dateStr] = null; await fetch('/api/remove', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ employee_id: empId, date_str: dateStr }) }); };
                
                const getShopCount = (locId, date) => { let count = 0; for (const empId in grid.value) { const shift = grid.value[empId][date]; if (shift && shift.id === locId) count++; } return count; };
                const countDays = (empId) => grid.value[empId] ? Object.values(grid.value[empId]).filter(l => l !== null).length : 0;
                
                const getDayName = (dStr) => ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][new Date(dStr + 'T00:00:00').getDay()];
                const formatDateShort = (dStr) => dStr.split('-').slice(1).join('/');
                const formatDateReadable = (dStr) => new Date(dStr + 'T00:00:00').toLocaleDateString(undefined, { month:'long', day:'numeric' });
                const getInitials = (name) => name.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();
                const showModal = (mode) => { modalMode.value = mode; newItemName.value = ""; };
                
                onMounted(() => { fetchData(); });
                
                return { 
                    currentMonday, employees, locations, weekDates, grid, isAdmin, showCoverage, constraints,
                    modalMode, passwordInput, newItemName, selectedEmp, showModal, openConstraints, toggleConstraint,
                    fetchData, changeWeek, login, logout, createItem, updateItem, deleteItem,
                    onDragStart, onDrop, removeShift, getShopCount, getWarning,
                    getDayName, formatDateShort, formatDateReadable, countDays, getInitials
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
